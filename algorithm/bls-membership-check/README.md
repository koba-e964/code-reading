# BLS curve における高速な所属判定

## 前提知識
BLS12-381 などの BLS 曲線は以下のように定義されている。[[Edg2023]]

- $u$: パラメーター。2 の高いベキを約数に持つべきである。
- $r = u^4 - u^2 + 1$ は素数。
- $p = (u-1)^2r/3 + u$ は素数。
- $E(\mathbb{F}_p): y^2 = x^3 + 4 \text{ in } \mathbb{F}_p$
  - 位数は $p-u = (u-1)^2r/3$ である。 $h_1 := (u-1)^2/3$ とすれば $h_1r$ と表せる。
- $E'(\mathbb{F} _ {p^2}): y^2 = x^3 + 4(1+i) \text{ in } \mathbb{F} _ {p^2}$
  - $i$ は $i^2 = -1$ を満たす。
  - 位数は $h_2r$ である。ただし $h_2 :=$ (複雑な $u$ の式) であり $\mathrm{gcd}(h_1,h_2) = 1$ を満たす。
- $\mathbb{G} _ 1 := E(\mathbb{F} _ p)[r]$ は位数 $r$ の巡回群。
- $\mathbb{G} _ 2 := E'(\mathbb{F} _ {p^2})[r]$ は位数 $r$ の巡回群。
- $\mathbb{G} _ T := (\mathbb{F} _ {p^{12}})^{\times}[r]$ は位数 $r$ の巡回群。

$E(\mathbb{F} _ p)$ や $E'(\mathbb{F} _ {p^2})$ の点が与えられたとき、それが $\mathbb{G}_1$ や $\mathbb{G}_2$ に属するとは限らないため、所属判定が必要である。そのような判定は $rP = O$ かどうかの判定で簡単にできるが、ここではそれよりも高速な手法を扱う。

## $\psi$ の定義
TODO

## $\mathbb{G}_1$
$E(\mathbb{F} _ p)$ において $\psi(x, y) = (\beta x, y)$ が成立する。ただし $\beta$ は曲線ごとに定まる 1 の原始 3 乗根である。

$P \in E(\mathbb{F} _ p)$ に対して
$\psi(P) = -u^2P$ か判定する。


```python
sage: cubes = K1(1).nth_root(3, all=True)
sage: beta = cubes[1]
sage: P = E1.random_element()
sage: P = P * h1
sage: P.order() == r
True
sage: P * -u ** 2
(3126677827507131137551612346322474528623637437092901144513904958320475879900120620774809383224647715732722255433774 : 2527831556190061956651825641300690290268682906768534493232425655332412517060917145910874168229356977845274712227904 : 1)
sage: P
(836239547948968319817613878632163231170358744090243783663231996895249120411323177922833253354172930878767784380075 : 2527831556190061956651825641300690290268682906768534493232425655332412517060917145910874168229356977845274712227904 : 1)
sage: (P * -u ** 2)[0] / P[0]
793479390729215512621379701633421447060886740281060493010456487427281649075476305620758731620350
sage: P * (u ** 2 - 1)
(39492179765567936048563600781266396762886638755862957154921180908306650179394065745044992550195017426404232745938 : 2527831556190061956651825641300690290268682906768534493232425655332412517060917145910874168229356977845274712227904 : 1)
sage: (P * (u ** 2 - 1))[0] / P[0]
4002409555221667392624310435006688643935503118305586438271171395842971157480381377015405980053539358417135540939436
sage: cubes
[1,
 793479390729215512621379701633421447060886740281060493010456487427281649075476305620758731620350,
 4002409555221667392624310435006688643935503118305586438271171395842971157480381377015405980053539358417135540939436]
```

証明:
- ($\Rightarrow$ (BLS12-381 のみ)): $rP = O$ を仮定する。上の例の点を $P_0$ とすると、 $P_0$ は位数が $r$ であり $\psi(P _ 0) = -u^2P _ 0$ を満たす。 $P = kP _ 0$ なる $k$ をとると、 $\psi(P) = \psi(kP _ 0) = k\psi(P _ 0) = k(-u^2P _ 0) = -u^2 P$ が成立する。
- ($\Leftarrow$): $\psi(P) = -u^2P$ を仮定する。 $\psi^2(P) + \psi(P) + P = u^4P - u^2P + P = rP$ より、 $\psi^2(P) + \psi(P) + P = O$ を示せば良い。 $\psi^2(P), \psi(P), P$ は同一直線上にある異なる 3 点であるので合計は $O$ である。
  - $P = (a,b)$ とおくと $\psi(P) = (\beta a, b), \psi^2(P) = (\beta^2 a, b)$ である。これらは直線 $y = b$ の上にある。

## $\mathbb{G}_2$
$Q \in E'(\mathbb{F} _ {p^2})$ に対して
$\psi(Q) = uP$ か判定する。

## $\mathbb{G}_T$
$w \in (\mathbb{F} _ {p^{12}})^{\times}$ に対して
$w^p = w^u$ か判定する。

# 参考文献

[[Edg2023]] Edgington, Ben. "BLS12-381 for the Rest of Us." HackMD, <https://hackmd.io/@benjaminion/bls12-381>. Accessed 18 May 2025.

[[Sco2011]] Scott, Michael. "A note on group membership tests for $\mathbb{G} _ 1$, $\mathbb{G} _ 2$ and $\mathbb{G} _ T$ on BLS pairing-friendly curves." Cryptology ePrint Archive (2021).

[Sco2011]: https://eprint.iacr.org/2021/1130

[Edg2023]: https://hackmd.io/@benjaminion/bls12-381
